#!/bin/bash
set -e

# Required environment variables in droplet:
# GIT_REPOSITORY: owner/repository
# GIT_BRANCH: branchname
# See also /bin/deploy from the project root
source .env

update_git() {
  local GIT_DIR=$1
  local GIT_URL=$2
  local BRANCH=$3
  echo "Updating git repo at $GIT_DIR"
  echo "URL: $GIT_URL"
  echo "Branch: $BRANCH"
  if [[ ! -d $GIT_DIR ]]; then
    git clone -b "$BRANCH" "$GIT_URL" "$GIT_DIR"
  fi
  pushd "$GIT_DIR"
  git remote set-url origin "$GIT_URL"
  git fetch
  git checkout -B "$BRANCH" --track "origin/$BRANCH" --force
  popd
}

update_git nginx https://github.com/Project-NISEI/nginx-proxy.git main
update_git cobra "https://github.com/$GIT_REPOSITORY.git" "$GIT_BRANCH"

pushd nginx
docker network inspect null_signal >/dev/null 2>&1 || \
    docker network create --driver bridge null_signal
docker compose up -d
popd

pushd cobra

{
  echo "RAILS_ENV=$RAILS_ENV"
  echo "POSTGRES_PASSWORD=$POSTGRES_PASSWORD"
  echo "SECRET_KEY_BASE=$SECRET_KEY_BASE"
  echo "COMPOSE_FILE=$COMPOSE_FILE"
  echo "COBRA_DOMAIN=$COBRA_DOMAIN"
  echo "NRDB_CLIENT=$NRDB_CLIENT"
  echo "NRDB_SECRET=$NRDB_SECRET"
  echo "NISEI_NRDB_CLIENT=$NISEI_NRDB_CLIENT"
  echo "NISEI_NRDB_SECRET=$NISEI_NRDB_SECRET"
  echo "VIRTUAL_HOST=$COBRA_DOMAIN"
  echo "VIRTUAL_PORT=3000"
  echo "LETSENCRYPT_HOST=$COBRA_DOMAIN"
  echo "LETSENCRYPT_EMAIL=website@nisei.net"
} > ".env"

cp config/database.example.yml config/database.yml
cp config/secrets.example.yml config/secrets.yml

bin/deploy

popd
