#!/bin/bash
set -e

PROJECT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && cd "../" && pwd)
pushd "${PROJECT_DIR}"

# Required environment variables in .env:
# RAILS_ENV: develop or production
# POSTGRES_PASSWORD: should be randomly generated per instance
# Optional:
# COMPOSE_FILE: prod, staging, override (for local dev - this is the default)
# Required if using prod compose file:
# COBRA_DOMAIN
# NISEI_DOMAIN
source .env
COMPOSE_FILE=${COMPOSE_FILE-override}

compose_for_deploy() {
  docker compose -f docker-compose.yml -f "docker-compose.$COMPOSE_FILE.yml" "$@"
}

compose_for_deploy up -d db
compose_for_deploy build app

bin/init-db

compose_for_deploy run --rm app rake assets:precompile --trace
compose_for_deploy up -d app

if [ "$COMPOSE_FILE" == "prod" ]; then
  bin/init-certbot
fi

compose_for_deploy up -d

popd
